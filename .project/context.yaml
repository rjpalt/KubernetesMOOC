# Machine Project Context (gitignored)
version: 1
azure:
  subscriptionEnvVar: AZURE_SUBSCRIPTION_ID
  subscriptionId: ede18d8a-a758-4a40-b15e-6eded5264b93
  resourceGroup: kubernetes-learning
  aksCluster: kube-mooc
  acr:
    loginServer: kubemooc.azurecr.io
    name: kubemooc
  managedIdentities:
    githubActionsCi:
      name: github-actions-ci
      clientId: a7c70b35-0eb3-4363-b0e1-1c48bae476cc
      scope: "CI/CD - Image building and testing"
      permissions:
        - "AcrPush on kubemooc registry"
      federatedCredentials:
        - name: github-actions-ci
          subject: "repo:rjpalt/KubernetesMOOC:pull_request"
          usage: "Pull request testing and builds"
        - name: github-actions-ci-main
          subject: "repo:rjpalt/KubernetesMOOC:ref:refs/heads/main"
          usage: "Main branch image builds"
    githubActionsCd:
      name: github-actions-todo-cd
      clientId: d2e20c1d-c71a-43d8-ba21-463212e9596f
      scope: "Production deployments to AKS"
      permissions:
        - "AcrPush on kubemooc registry"
        - "Azure Kubernetes Service Contributor Role on kube-mooc cluster"
      federatedCredentials:
        - name: github-actions-ci-cd
          subject: "repo:rjpalt/KubernetesMOOC:ref:refs/heads/main"
          usage: "Production deployments from main branch"
    keyvaultAccess:
      name: keyvault-identity-kube-mooc
      clientId: 9b82dc92-8be2-4de4-90e4-e99eefb44e9f
      scope: "Kubernetes workload access to Azure Key Vault"
      permissions:
        - "Key Vault Secrets User on kube-mooc-secrets vault"
      federatedCredentials:
        - name: postgres-workload-identity
          subject: "system:serviceaccount:project:postgres-service-account"
          usage: "PostgreSQL pods accessing database credentials"
    albController:
      name: azure-alb-identity
      scope: "Application Load Balancer controller operations"
      permissions:
        - "Reader on AKS node resource group"
        - "AppGw for Containers Configuration Manager on node resource group"
        - "Network Contributor on ALB subnet"
      federatedCredentials:
        - name: azure-alb-identity
          subject: "system:serviceaccount:azure-alb-system:alb-controller-sa"
          usage: "ALB controller managing Azure Application Gateway"
  storage:
    accountName: kubemoocbackups
    allowSharedKeyAccess: true  # TEMPORARY COMPROMISE: Enabled for CronJob backup compatibility
    networkRuleSetDefaultAction: Allow
    backupContainer: database-backups
    containers:
      production: database-backups
      feature: feature-backups
      local: local-backups
    # SECURITY COMPROMISE (temporary): Using storage account keys instead of Azure Workload Identity
    # Root cause: Azure Workload Identity webhook not injecting environment variables into CronJob pods
    # TODO: Revert to federated identity authentication during infrastructure revamp
    authenticationMethod: storage-account-key  # Should be: workload-identity
    temporaryCredentials:
      enabled: true
      reason: "Azure Workload Identity webhook compatibility issues with AKS CronJobs"
      created: "2025-08-12"
      revertBy: "Infrastructure revamp (see REVAMP_ROADMAP.md Phase 5)"
  backup:
    identities:
      production:
        name: backup-production-identity
        clientId: 50f96678-064c-463a-a3e3-2297a3b557f1
        principalId: 7b093f7e-28fa-40c1-b134-2540e64a70f1
        federatedCredential: backup-production-k8s
        serviceAccount: system:serviceaccount:project:postgres-backup-prod-service-account
        permissions:
          - container: database-backups
            role: Storage Blob Data Contributor
      development:
        name: backup-development-identity
        clientId: 640dd28d-3d3e-416d-aaf6-85c52a1f0db5
        principalId: 5da97818-5f7f-436d-8c97-64aecf0bbfa1
        federatedCredential: backup-development-k8s
        serviceAccount: system:serviceaccount:backup-shared:backup-serviceaccount
        permissions:
          - container: feature-backups
            role: Storage Blob Data Contributor
          - container: local-backups
            role: Storage Blob Data Contributor
kubernetes:
  featureNamespacePattern: feature-<branch>
  stableNamespaces:
    - default
    - kube-system
images:
  tagPattern: "{branch}-{sha}"
  repositories:
    - todo-app-be
    - todo-app-fe
workflows:
  ciName: "CI Pipeline - Microservices"
  featureDeployWorkflow: deploy-feature-branches.yml
  productionDeployWorkflow: deploy-production.yml
rules:
  allowedActions:
    azure:
      - aks_cluster_list
      - acr_repository_list
      - acr_repository_show_tags
    github:
      - list_pull_requests
      - get_pull_request
      - get_workflow_runs
notes:
  - Non-destructive operations only.
  - Update subscriptionId if environment changes.

dx:
  docsIndex:
    - docs/overview/onboarding.md
    - docs/overview/repo-map.md
    - docs/development/local-dev.md
    - docs/development/script-catalog.md
    - docs/testing/index.md
  serviceDocs:
    - course_project/TESTING_OVERVIEW.md
    - course_project/todo-backend/tests/TEST_PLAN.md
    - course_project/todo-app/TEST_PLAN.md
  docPlacement:
    root: indices-only
    courseProjectDocs: service-specific
  devModes:
    localDev: make local-dev  # uv apps + DB via backend compose
    compose: make compose-up   # all services in compose (attached)
  db:
    up: make db-up
    down: make db-down
  tests:
    all: make test
    backend: make test-be
    frontend: make test-fe
  buildQuality:
    build: make build-images TAG=<tag>  # updates course_project/docker-compose.yaml
    quality: make quality [CHECK=1]
  conventions:
    - no file moves without confirmation
    - root docs are short; link to canonical sources
    - Kubernetes: guidance only; do not implement

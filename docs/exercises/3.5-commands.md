# Exercise 3.5 Commands

**Project**: Course Project (todo-backend + todo-frontend + todo-cron)  
**Focus**: Gateway API with Azure Application Load Balancer Integration  
**Goal**: Deploy complete todo application stack with Gateway API routing on AKS

**Prerequisites**: Exercise 3.4 completed, Azure Application Load Balancer configured

## Commands

### Build and Push Course Project Images
Logging in to ACR:
```bash
az acr login --name kubemooc
```

```bash
# Build course project images
./build-images.sh v3.5

# Tag for your container registry (adjust registry URL as needed)
docker tag todo-app-be:3.5-amd64 kubemooc.azurecr.io/todo-app-be:3.5-amd64
docker tag todo-app-fe:3.5-amd64 kubemooc.azurecr.io/todo-app-fe:3.5-amd64
docker tag todo-app-cron:3.5-amd64 kubemooc.azurecr.io/todo-app-cron:3.5-amd64

# Push to registry
docker push kubemooc.azurecr.io/todo-app-be:3.5-amd64
docker push kubemooc.azurecr.io/todo-app-fe:3.5-amd64
docker push kubemooc.azurecr.io/todo-app-cron:3.5-amd64
```

### Deploy Shared Resources
```bash
# Apply shared resources (Gateway API, namespaces, etc.)
kubectl apply -k manifests/base/shared/
```

### Deploy PostgreSQL Database
```bash
# Apply PostgreSQL StatefulSet and Service
kubectl apply -k manifests/base/postgres/

# Verify PostgreSQL deployment
kubectl get pods -l app=postgres
kubectl get pvc
kubectl logs -l app=postgres
```

### Deploy Backend Service
```bash
# Apply todo-backend deployment
kubectl apply -k manifests/base/todo-be/

# Verify backend deployment
kubectl get pods -l app=todo-backend
kubectl get svc todo-backend-svc
kubectl logs -l app=todo-backend
```

### Deploy Frontend Service
```bash
# Apply todo-frontend deployment
kubectl apply -k manifests/base/todo-fe/

# Verify frontend deployment
kubectl get pods -l app=todo-frontend
kubectl get svc todo-frontend-svc
kubectl logs -l app=todo-frontend
```

### Deploy Cron Job
```bash
# Apply todo-cron job
kubectl apply -k manifests/base/todo-cron/

# Verify cron job
kubectl get cronjobs
kubectl get jobs
```

### Test Complete Application Stack
```bash
# Get Gateway FQDN
fqdn=$(kubectl get gateway k8s-nsa2-gateway -n nsa2 -o jsonpath='{.status.addresses[0].value}')
echo "Gateway FQDN: $fqdn"

# Test frontend (should serve content)
curl http://$fqdn/project/
# Expected: HTML content or 200 OK

# Alternative test with headers only
curl -I http://$fqdn/project/
# Expected: May return 405 Method Not Allowed (HEAD not supported) but proves routing works

# Test backend API endpoints
curl http://$fqdn/project/be-health
# Expected: {"status":"healthy","service":"todo-backend","todos_count":X}

# Note: /project/todos now routes to frontend (returns HTML), not backend JSON
# To test backend API directly, you would need a different route like /project/api/todos
curl http://$fqdn/project/todos
# Expected: HTML page content (frontend response, not JSON)

# Test frontend image endpoints  
curl http://$fqdn/project/image/info
# Expected: JSON with image metadata and cache status

curl -I http://$fqdn/project/image
# Expected: 405 Method Not Allowed (HEAD not supported) but Allow: GET header present

# Test creating a new todo (now goes through frontend)
# This should work with form data or JSON, frontend will proxy to backend
curl -X POST http://$fqdn/project/todos \
  -H "Content-Type: application/json" \
  -d '{"text": "Test todo from Gateway API"}'
# Expected: HTML fragment response (HTMX response from frontend)

# To verify the todo was created, check via backend health endpoint
curl http://$fqdn/project/be-health
# Expected: {"status":"healthy","service":"todo-backend","todos_count":X} (count increased)
```

### Verify Application Functionality
```bash
# Check all pods are running
kubectl get pods

# Check services are accessible
kubectl get svc

# Verify persistent storage
kubectl get pvc
kubectl describe pvc postgres-data-postgres-statefulset-0

# Check cron job execution
kubectl get jobs
kubectl logs job/<job-name>
```

### Monitor Application Logs
```bash
# Backend logs
kubectl logs -l app=todo-backend --tail=20

# Frontend logs
kubectl logs -l app=todo-frontend --tail=20

# Database logs
kubectl logs -l app=postgres --tail=20

# Cron job logs
kubectl logs -l app=todo-cron --tail=10
```

### Test Application in Browser
```bash
# Open application in browser
echo "Application available at: http://$fqdn/project"

# Test full workflow:
# 1. Open browser to http://$fqdn
# 2. Create new todos through UI
# 3. Verify todos persist after page refresh
# 4. Check that random Wikipedia todos appear (from cron job)
```

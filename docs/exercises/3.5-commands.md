# Exercise 3.5 Commands

**Project**: Course Project (todo-backend + todo-frontend + todo-cron)  
**Focus**: Gateway API with Azure Application Load Balancer Integration  
**Goal**: Deploy complete todo application stack with Gateway API routing on AKS

**Prerequisites**: Exercise 3.4 completed, Azure Application Load Balancer configured

## Commands

### Build and Push Course Project Images
Logging in to ACR:
```bash
az acr login --name kubemooc
```

```bash
# Build course project images
./build-images.sh v3.5

# Tag for your container registry (adjust registry URL as needed)
docker tag todo-backend:3.5 kubemooc.azurecr.io/todo-backend:3.5
docker tag todo-frontend:3.5 kubemooc.azurecr.io/todo-frontend:3.5
docker tag todo-cron:3.5 kubemooc.azurecr.io/todo-cron:3.5

# Push to registry
docker push kubemooc.azurecr.io/todo-backend:3.5
docker push kubemooc.azurecr.io/todo-frontend:3.5
docker push kubemooc.azurecr.io/todo-cron:3.5
```

### Deploy PostgreSQL Database
```bash
# Apply PostgreSQL StatefulSet and Service
kubectl apply -k manifests/base/postgres/

# Verify PostgreSQL deployment
kubectl get pods -l app=postgres
kubectl get pvc
kubectl logs -l app=postgres
```

### Deploy Backend Service
```bash
# Apply todo-backend deployment
kubectl apply -k manifests/base/todo-be/

# Verify backend deployment
kubectl get pods -l app=todo-backend
kubectl get svc todo-backend-svc
kubectl logs -l app=todo-backend
```

### Deploy Frontend Service
```bash
# Apply todo-frontend deployment
kubectl apply -k manifests/base/todo-fe/

# Verify frontend deployment
kubectl get pods -l app=todo-frontend
kubectl get svc todo-frontend-svc
kubectl logs -l app=todo-frontend
```

### Deploy Cron Job
```bash
# Apply todo-cron job
kubectl apply -k manifests/base/todo-cron/

# Verify cron job
kubectl get cronjobs
kubectl get jobs
```

### Configure Gateway API Routes
```bash
# Apply HTTPRoute for todo application
kubectl apply -f manifests/base/shared/todo-httproute.yaml

# Check HTTPRoute status
kubectl describe httproute todo-route -n nsa2

# Verify route configuration
kubectl get httproute todo-route -n nsa2 -o yaml
```

### Test Complete Application Stack
```bash
# Get Gateway FQDN
fqdn=$(kubectl get gateway k8s-nsa2-gateway -n nsa2 -o jsonpath='{.status.addresses[0].value}')
echo "Gateway FQDN: $fqdn"

# Test frontend (should serve React app)
curl -I http://$fqdn/
# Expected: 200 OK with HTML content

# Test backend API endpoints
curl http://$fqdn/be-health
# Expected: {"status": "ok", "todo_count": X}

curl http://$fqdn/todos
# Expected: [] or existing todos JSON array

# Test creating a new todo
curl -X POST http://$fqdn/todos \
  -H "Content-Type: application/json" \
  -d '{"text": "Test todo from Gateway API"}'
# Expected: Created todo JSON object

# Test retrieving created todo
curl http://$fqdn/todos
# Expected: Array containing the created todo
```

### Verify Application Functionality
```bash
# Check all pods are running
kubectl get pods --all-namespaces

# Check services are accessible
kubectl get svc

# Verify persistent storage
kubectl get pvc
kubectl describe pvc postgres-data-postgres-statefulset-0

# Check cron job execution
kubectl get jobs
kubectl logs job/<job-name>
```

### Monitor Application Logs
```bash
# Backend logs
kubectl logs -l app=todo-backend --tail=20

# Frontend logs
kubectl logs -l app=todo-frontend --tail=20

# Database logs
kubectl logs -l app=postgres --tail=20

# Cron job logs
kubectl logs -l app=todo-cron --tail=10
```

### Test Application in Browser
```bash
# Open application in browser
echo "Application available at: http://$fqdn"

# Test full workflow:
# 1. Open browser to http://$fqdn
# 2. Create new todos through UI
# 3. Verify todos persist after page refresh
# 4. Check that random Wikipedia todos appear (from cron job)
```

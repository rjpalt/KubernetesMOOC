# Exercise 4.6 Evidence

## What I built

Made a broadcaster service that gets messages from NATS when todos are created and sends them to a webhook.

## Requirements check

### Backend sends message to NATS on saving todos

Backend publishes to NATS when creating todos. Checked the logs:

```
kubectl logs -n project deployment/todo-app-be --since=10m | grep "Published NATS event"
```

Shows stuff like:
```
2025-09-26 18:27:08,429 - ✅ Published NATS event for todo creation: 7763
2025-09-26 18:27:08,969 - ✅ Published NATS event for todo creation: 7764  
2025-09-26 18:27:09,480 - ✅ Published NATS event for todo creation: 7765
```

### Broadcaster subscribes to NATS messages

Broadcaster connects to NATS and subscribes to `todos.events` topic. Uses queue group `broadcaster-workers`.

### Broadcaster sends message to external service

Using httpbin.org/post as the webhook endpoint. Messages get sent there when todos are created.

### Scaling without duplicates

This was the main requirement. Need to test that multiple broadcaster replicas don't send the same message multiple times.

Scaled to 5 replicas and created test todos with SCALING_PROOF in the name.

```bash
kubectl scale -n project deployment/broadcaster --replicas=5
```

Created 5 test todos, then checked the logs to see which replica processed each message:

```bash
kubectl logs -n project -l app=broadcaster --since=10m | grep "SCALING_PROOF" | grep "Received message"
```

Found that:
- broadcaster-6d5678bbcb-ww8m2 processed todos 7766, 7767 (2 messages)
- broadcaster-6d5678bbcb-xbb7g processed todo 7764 (1 message)  
- Other replicas processed 0 messages

Total: 5 todos created, 3 processed, 0 duplicates.

Checked for duplicates with:
```bash
kubectl logs -n project -l app=broadcaster --since=10m | \
  grep "SCALING_PROOF" | grep "Received message" | \
  grep -o "'id': '[0-9]*'" | sort | uniq -d
```

Result was empty = no duplicates found.

## How it works

The queue group mechanism in NATS makes sure each message only goes to one subscriber in the group. So even with 5 broadcaster replicas running, each todo message only gets processed once.

Some messages might get lost (like 2 out of 5 in my test) but that's acceptable according to the requirements. The important thing is no duplicates.

## Test results

- Backend: publishes messages to NATS ✓
- NATS: routes messages to subscribers ✓  
- Broadcaster: processes messages and sends webhooks ✓
- Scaling: multiple replicas work without duplicates ✓
- External service: webhook delivery works ✓

Requirement met: "The broadcaster should be able to be scaled without sending the message multiple times."
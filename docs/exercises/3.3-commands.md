# Exercise 3.3 Commands

**Project**: ping-pong + log_output  
**Focus**: AKS deployment with Gateway API (switching from Ingress)

**Prerequisites**: Azure ALB Controller setup completed (see Azure-memos.md for full Azure infrastructure setup)

## Commands

### Apply Gateway Infrastructure
```bash
# Apply Application Load Balancer resource
kubectl apply -f cluster-manifests/nsa2-alb.yaml

# Apply Gateway resource (enables cross-namespace routing)
kubectl apply -f cluster-manifests/k8s-nsa2-gateway.yaml

# Check Gateway status
kubectl get gateway k8s-nsa2-gateway -n nsa2
```

### Get Gateway Address
```bash
# Store Gateway FQDN
fqdn=$(kubectl get gateway k8s-nsa2-gateway -n nsa2 -o jsonpath='{.status.addresses[0].value}')
echo "Gateway FQDN: $fqdn"
```

### Apply Health Check Policy
```bash
# Apply custom health check for ping-pong service (fixes "no healthy upstream" error)
kubectl apply -f ping-pong/manifests/ping-pong/ping-pong-health-check-policy.yaml

# Verify policy applied
kubectl get healthcheckpolicy ping-pong-health-check -n exercises
```

### Remove Ingress and Apply HTTPRoute
```bash
# Delete existing Ingress
kubectl delete ingress ping-pong-ingress -n exercises

# Apply HTTPRoute
kubectl apply -f ping-pong/manifests/ping-pong/ping-pong-route.yaml

# Check HTTPRoute status
kubectl describe httproute ping-pong-route -n exercises
```

### Test Endpoints
```bash
# Test root path (log-output-svc)
curl http://$fqdn/

# Test ping-pong endpoints
curl http://$fqdn/pingpong
curl http://$fqdn/pings
```

### Troubleshooting Commands
```bash
# Test service health directly
kubectl run test-pod --image=busybox --rm -it --restart=Never -n exercises -- wget -qO- http://ping-pong-svc:2507/health

# Check ALB Controller logs
kubectl logs -n azure-alb-system -l app=alb-controller --tail=50
```

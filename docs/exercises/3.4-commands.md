# Exercise 3.4 Commands

**Project**: ping-pong + log_output  
**Focus**: Gateway API Route Rewriting with ReplacePrefixMatch  
**Goal**: External `/pingpong` requests rewritten to internal `/` endpoint

**Prerequisites**: Exercise 3.3 completed (Gateway API setup working)

## Commands

### Build and Push Updated Images
Logging in to ACR:
```bash
az acr login --name kubemooc
```

```bash
# Build new images with app-level changes (ping-pong now responds at '/')
./build-apps.sh v3.4

# Tag for your container registry (adjust registry URL as needed)
docker tag ping-pong-app:3.4 kubemooc.azurecr.io/ping-pong-app:3.4
docker tag log-output-app:3.4 kubemooc.azurecr.io/log-output-app:3.4


# Push to registry
docker push kubemooc.azurecr.io/ping-pong-app:3.4
docker push kubemooc.azurecr.io/log-output-app:3.4
```

### Update Deployment Manifests
```bash
# Update ping-pong deployment to use new image version
kubectl apply -f manifests/ping-pong/ping-pong-deployment.yaml
# Update log-output deployment to use new image version
kubectl apply -f manifests/log-output/log-output-deployment.yaml
```

### Update HTTPRoute with Route Rewriting
```bash
# Apply updated HTTPRoute with URLRewrite filters
kubectl apply -f ping-pong/manifests/ping-pong/ping-pong-route.yaml

# Check HTTPRoute status
kubectl describe httproute ping-pong-route -n exercises

# Verify route configuration
kubectl get httproute ping-pong-route -n exercises -o yaml
```

### Test Route Rewriting
```bash
# Get Gateway FQDN
fqdn=$(kubectl get gateway k8s-nsa2-gateway -n nsa2 -o jsonpath='{.status.addresses[0].value}')
echo "Gateway FQDN: $fqdn"

# Test external /pingpong (should be rewritten to internal /)
curl http://$fqdn/pingpong
# Expected: {"message": "pong 0"} (or current counter value)

# Test /pings endpoint (unchanged)
curl http://$fqdn/pings
# Expected: {"pings": 1} (or current counter value)

# Test root path (should still go to log-output-svc)
curl http://$fqdn/
# Expected: log-output service response
```

### Verify Route Rewriting Behavior
```bash
# Test multiple pings to verify counter increment
curl http://$fqdn/pingpong
curl http://$fqdn/pingpong
curl http://$fqdn/pings

# Verify logs show requests hitting '/' internally
kubectl logs -l app=ping-pong -n exercises --tail=10
```


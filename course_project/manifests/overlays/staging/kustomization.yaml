apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Staging overlay - used for deploying to staging namespace
# Usage: 
#   cd course_project/manifests/overlays/staging
#   kustomize edit set image [images...]
#   kustomize build . | kubectl apply -f -

namespace: staging

# Namespace Definition (Overlay-Specific Pattern)
#
# namespace.yaml is defined here (not in base/shared/) because:
#   1. Staging uses agc-feature-gateway which requires dev-gateway-access=allowed label
#   2. Prevents Kustomize transformation conflicts with base namespace
#   3. Enables explicit per-environment gateway configuration
#   4. Different from production label (gateway-access vs dev-gateway-access)
#
# Gateway: agc-feature-gateway (development/staging gateway)
# Required Label: dev-gateway-access=allowed

resources:
- namespace.yaml
- ../../base/shared/
- ../../base/todo-be/
- ../../base/todo-fe/
- ../../base/nats/
- ../../base/broadcaster/
- resourcequota.yaml
- hpa-backend.yaml
- hpa-frontend.yaml
- hpa-broadcaster.yaml


# Patch HTTPRoute for AGC gateway with hostname-based routing, frontend for clean URLs (no path prefix), and NATS for cost optimization

# Backend Database Configuration Patch (Staging DBaaS)
#
# CRITICAL: Array indices are ZERO-BASED
# Base deployment env array:
#   env[0] = PORT
#   env[1] = LOG_LEVEL
#   env[2] = KUBERNETES_NAMESPACE
#   env[3] = POSTGRES_HOST          <- Patched here
#   env[4] = POSTGRES_PORT
#   env[5] = POSTGRES_DB
#   env[6] = POSTGRES_USER          <- Patched here
#   env[7] = POSTGRES_PASSWORD      <- Patched here
#
# Volumes array:
#   volumes[0]/csi/volumeAttributes/secretProviderClass <- Patched here
#
# Always verify indices in base/todo-be/deployment.yaml before modifying
patches:
- patch: |-
    - op: replace
      path: /spec/parentRefs
      value:
        - name: agc-feature-gateway
          namespace: agc-shared
    - op: add
      path: /spec/hostnames
      value:
        - "staging.23.98.101.23.nip.io"
    - op: replace
      path: /spec/rules
      value:
        - matches:
          - path:
              type: PathPrefix
              value: /be-health
          backendRefs:
            - name: todo-app-be-svc
              port: 2506
        - matches:
          - path:
              type: PathPrefix
              value: /docs
          backendRefs:
            - name: todo-app-be-svc
              port: 2506
        - matches:
          - path:
              type: PathPrefix
              value: /api
          backendRefs:
            - name: todo-app-be-svc
              port: 2506
        - matches:
          - path:
              type: PathPrefix
              value: /image
          backendRefs:
            - name: todo-app-fe-svc
              port: 2507
        - matches:
          - path:
              type: PathPrefix
              value: /todos
          backendRefs:
            - name: todo-app-fe-svc
              port: 2507
        - matches:
          - path:
              type: PathPrefix
              value: /
          backendRefs:
            - name: todo-app-fe-svc
              port: 2507
  target:
    kind: HTTPRoute
    name: todo-app
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/env/3/value
      value: ""
  target:
    kind: Deployment
    name: todo-app-fe
- path: nats-staging-patch.yaml
- patch: |-
    - op: replace
      path: /spec/ingress/1/from/0/namespaceSelector/matchLabels/kubernetes.io~1metadata.name
      value: staging
  target:
    kind: NetworkPolicy
    name: nats
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/env/3/value
      value: "kubemooc-postgres-feature.postgres.database.azure.com"
    - op: replace
      path: /spec/template/spec/containers/0/env/5/value
      value: "todoapp_staging"
    - op: replace
      path: /spec/template/spec/containers/0/env/6/valueFrom/secretKeyRef/name
      value: "postgres-secret-staging"
    - op: replace
      path: /spec/template/spec/containers/0/env/7/valueFrom/secretKeyRef/name
      value: "postgres-secret-staging"
    - op: replace
      path: /spec/template/spec/volumes/0/csi/volumeAttributes/secretProviderClass
      value: "postgres-secret-provider-staging"
  target:
    kind: Deployment
    name: todo-app-be

images:
- name: kubemooc.azurecr.io/broadcaster
  newName: kubemooc.azurecr.io/broadcaster
  newTag: main-629a74e6be574a6a4672da6aeab4fc23749f63e3
- name: kubemooc.azurecr.io/todo-app-be
  newName: kubemooc.azurecr.io/todo-app-be
  newTag: main-629a74e6be574a6a4672da6aeab4fc23749f63e3
- name: kubemooc.azurecr.io/todo-app-cron
  newName: kubemooc.azurecr.io/todo-app-cron
  newTag: main-629a74e6be574a6a4672da6aeab4fc23749f63e3
- name: kubemooc.azurecr.io/todo-app-fe
  newName: kubemooc.azurecr.io/todo-app-fe
  newTag: main-629a74e6be574a6a4672da6aeab4fc23749f63e3

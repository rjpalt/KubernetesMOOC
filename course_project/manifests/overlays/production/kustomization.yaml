apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Production overlay - used for deploying main branch to project namespace
# Usage: 
#   cd course_project/manifests/overlays/production
#   kustomize edit set image [images...]
#   kustomize build . | kubectl apply -f -

namespace: project

# Namespace Definition (Overlay-Specific Pattern)
#
# namespace.yaml is defined here (not in base/shared/) because:
#   1. Production uses k8s-nsa2-gateway which requires gateway-access=allowed label
#   2. Prevents Kustomize transformation conflicts with base namespace
#   3. Enables explicit per-environment gateway configuration
#
# Gateway: k8s-nsa2-gateway (production gateway)
# Required Label: gateway-access=allowed

resources:
- namespace.yaml
- ../../base/shared/
- ../../base/todo-be/
- ../../base/todo-fe/
- ../../base/nats/
- ../../base/broadcaster/
- resourcequota.yaml
- hpa-backend.yaml
- hpa-frontend.yaml
- hpa-broadcaster.yaml


# Patch API_BASE_PATH for production path-based routing through /project/ and add NATS production patch for HA and storage optimization

# Backend Database Configuration Patch (Production DBaaS)
#
# CRITICAL: Array indices are ZERO-BASED
# Base deployment env array:
#   env[0] = PORT
#   env[1] = LOG_LEVEL
#   env[2] = KUBERNETES_NAMESPACE
#   env[3] = POSTGRES_HOST          <- Patched here
#   env[4] = POSTGRES_PORT
#   env[5] = POSTGRES_DB
#   env[6] = POSTGRES_USER          <- Patched here
#   env[7] = POSTGRES_PASSWORD      <- Patched here
#
# Always verify indices in base/todo-be/deployment.yaml before modifying
patches:
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/env/3/value
      value: "/project"
  target:
    kind: Deployment
    name: todo-app-fe
- path: nats-prod-patch.yaml
- patch: |-
    - op: replace
      path: /spec/ingress/1/from/0/namespaceSelector/matchLabels/kubernetes.io~1metadata.name
      value: project
  target:
    kind: NetworkPolicy
    name: nats
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/env/3/value
      value: "kubemooc-postgres-prod.postgres.database.azure.com"
    - op: replace
      path: /spec/template/spec/containers/0/env/6/valueFrom/secretKeyRef/name
      value: "postgres-secret-prod"
    - op: replace
      path: /spec/template/spec/containers/0/env/7/valueFrom/secretKeyRef/name
      value: "postgres-secret-prod"
  target:
    kind: Deployment
    name: todo-app-be

images:
- name: kubemooc.azurecr.io/broadcaster
  newName: kubemooc.azurecr.io/broadcaster
  newTag: main-c945b89bbfd82a5ca2e1629e3fa2c8327703b855
- name: kubemooc.azurecr.io/todo-app-be
  newName: kubemooc.azurecr.io/todo-app-be
  newTag: main-c945b89bbfd82a5ca2e1629e3fa2c8327703b855
- name: kubemooc.azurecr.io/todo-app-cron
  newName: kubemooc.azurecr.io/todo-app-cron
  newTag: main-c945b89bbfd82a5ca2e1629e3fa2c8327703b855
- name: kubemooc.azurecr.io/todo-app-fe
  newName: kubemooc.azurecr.io/todo-app-fe
  newTag: main-c945b89bbfd82a5ca2e1629e3fa2c8327703b855

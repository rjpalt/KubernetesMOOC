apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Production overlay - used for deploying main branch to project namespace
# Usage: 
#   cd course_project/manifests/overlays/production
#   kustomize edit set image [images...]
#   kustomize build . | kubectl apply -f -

namespace: project

resources:
- ../../base/shared/
- ../../base/todo-be/
- ../../base/todo-fe/
- ../../base/nats/
- ../../base/broadcaster/
- resourcequota.yaml
- hpa-backend.yaml
- hpa-frontend.yaml
- hpa-broadcaster.yaml


# Patch API_BASE_PATH for production path-based routing through /project/ and add NATS production patch for HA and storage optimization
patches:
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/env/3/value
      value: "/project"
  target:
    kind: Deployment
    name: todo-app-fe
- path: nats-prod-patch.yaml
- patch: |-
    - op: replace
      path: /spec/ingress/1/from/0/namespaceSelector/matchLabels/kubernetes.io~1metadata.name
      value: project
  target:
    kind: NetworkPolicy
    name: nats
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/env/3/value
      value: "kubemooc-postgres-prod.postgres.database.azure.com"
    - op: replace
      path: /spec/template/spec/containers/0/env/6/valueFrom/secretKeyRef/name
      value: "postgres-secret-prod"
    - op: replace
      path: /spec/template/spec/containers/0/env/7/valueFrom/secretKeyRef/name
      value: "postgres-secret-prod"
  target:
    kind: Deployment
    name: todo-app-be

images:
- name: kubemooc.azurecr.io/broadcaster
  newName: kubemooc.azurecr.io/broadcaster
  newTag: main-a8033209015e77eb7df93693587e4b2dbde23f8e
- name: kubemooc.azurecr.io/todo-app-be
  newName: kubemooc.azurecr.io/todo-app-be
  newTag: main-a8033209015e77eb7df93693587e4b2dbde23f8e
- name: kubemooc.azurecr.io/todo-app-cron
  newName: kubemooc.azurecr.io/todo-app-cron
  newTag: main-a8033209015e77eb7df93693587e4b2dbde23f8e
- name: kubemooc.azurecr.io/todo-app-fe
  newName: kubemooc.azurecr.io/todo-app-fe
  newTag: main-a8033209015e77eb7df93693587e4b2dbde23f8e

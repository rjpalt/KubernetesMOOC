name: Staging Tests

on:
  workflow_run:
    workflows: ["Staging Deployment"]
    types:
      - completed
    branches:
      - main

permissions:
  contents: write  # Required for Git tag creation

jobs:
  get-staging-urls:
    name: Get Staging URLs
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      backend_url: ${{ steps.get-urls.outputs.backend_url }}
      frontend_url: ${{ steps.get-urls.outputs.frontend_url }}
    
    steps:
      - name: Download staging URL artifact
        uses: actions/download-artifact@v4
        with:
          name: staging-deployment-url
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Read and derive staging URLs
        id: get-urls
        run: |
          # Read the frontend URL from artifact
          FRONTEND_URL=$(cat staging_url.txt)
          
          # Derive backend URL (backend is at /be path on same domain)
          BACKEND_URL="${FRONTEND_URL}"
          
          echo "backend_url=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          echo "Backend URL: $BACKEND_URL"
          echo "Frontend URL: $FRONTEND_URL"
          
          echo "## Staging Test URLs ðŸ”—" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend URL:** $FRONTEND_URL" >> $GITHUB_STEP_SUMMARY
          echo "**Backend URL:** $BACKEND_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Staging deployment validated by deploy-staging.yml workflow" >> $GITHUB_STEP_SUMMARY

  test-l2:
    name: L2 Service Integration Tests
    needs: get-staging-urls
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: Install dependencies
        working-directory: course_project/tests/staging
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install pytest pytest-asyncio httpx pytest-html
      
      - name: Run L2 tests
        working-directory: course_project/tests/staging
        env:
          STAGING_BACKEND_URL: ${{ needs.get-staging-urls.outputs.backend_url }}
          STAGING_FRONTEND_URL: ${{ needs.get-staging-urls.outputs.frontend_url }}
        run: |
          source .venv/bin/activate
          pytest -v --html=test-report-l2.html --self-contained-html
      
      - name: Upload L2 test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: l2-test-results
          path: course_project/tests/staging/test-report-l2.html
          retention-days: 7
      
      - name: Update GitHub summary
        if: always()
        run: |
          echo "## L2 Service Integration Test Results ðŸ”¬" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Backend URL:** ${{ needs.get-staging-urls.outputs.backend_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend URL:** ${{ needs.get-staging-urls.outputs.frontend_url }}" >> $GITHUB_STEP_SUMMARY

  test-l3:
    name: L3 End-to-End Tests
    needs: get-staging-urls
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        working-directory: course_project/tests/e2e
        run: npm ci
      
      - name: Install Playwright browsers
        working-directory: course_project/tests/e2e
        run: npx playwright install --with-deps chromium
      
      - name: Run E2E tests
        working-directory: course_project/tests/e2e
        env:
          TARGET_URL: ${{ needs.get-staging-urls.outputs.frontend_url }}
        run: npm test
      
      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: l3-test-results
          path: |
            course_project/tests/e2e/playwright-report/
            course_project/tests/e2e/test-results/
          retention-days: 7
      
      - name: Update GitHub summary
        if: always()
        run: |
          echo "## L3 End-to-End Test Results ðŸŒ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target URL:** ${{ needs.get-staging-urls.outputs.frontend_url }}" >> $GITHUB_STEP_SUMMARY

  tag-prod-ready:
    name: Tag Production Ready
    needs: [test-l2, test-l3]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Create production-ready tag
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          TAG_NAME="prod-ready-${TIMESTAMP}-${COMMIT_SHA}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git tag -a "$TAG_NAME" -m "Staging tests passed - ready for production promotion"
          git push origin "$TAG_NAME"
          
          echo "## Production Ready Tag Created ðŸ·ï¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag Name:** \`$TAG_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`$COMMIT_SHA\`" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… All staging tests passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This commit is ready for production promotion." >> $GITHUB_STEP_SUMMARY
